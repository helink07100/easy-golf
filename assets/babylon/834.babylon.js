"use strict";(self.webpackChunkBABYLON=self.webpackChunkBABYLON||[]).push([[612,834,999],{5834:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>g});var n=r(998),s=r(9923),i=r(4867),o=r(4640),a=r(854),l=r(2667),u=(r(1466),r(7891)),d=r(1137);r(2809);var p=r(6755);l.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(l.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=p.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0}),r(5999);const c="image/png",f=[134,22,135,150,246,214,150,54];function h(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:c}}function m(e,t,s){const o=(s=h(s)).specular;return o?(e._lodGenerationScale=o.lodGenerationScale,async function(e,t,s=c){if(!n.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const o=(0,i.C0)(e.width)+1,d=e.getEngine();let p=!1,f=!1,h=null,m=null,g=null;const _=d.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,d.updateTextureSamplingMode(3,e),_.textureLOD?d._features.supportRenderAndCopyToLodForFloatTextures?_.textureHalfFloatRender&&_.textureHalfFloatLinearFiltering?(p=!0,e.type=2):_.textureFloatRender&&_.textureFloatLinearFiltering&&(p=!0,e.type=1):p=!1:(p=!1,f=!0,g={});let v=0;if(p)d.isWebGPU?(v=1,await r.e(371).then(r.bind(r,371))):await r.e(682).then(r.bind(r,9682)),h=new u.w("rgbdDecode","rgbdDecode",null,null,1,null,3,d,!1,void 0,e.type,void 0,null,!1,void 0,v),e._isRGBD=!1,e.invertY=!1,m=d.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,f){const t=3,r=e._lodGenerationScale,n=e._lodGenerationOffset;for(let s=0;s<t;s++){const i=(o-1)*r+n,u=n+(i-n)*(1-s/(t-1)),p=Math.round(Math.min(Math.max(u,0),i)),c=new a.h(d,2);c.isCube=!0,c.invertY=!0,c.generateMipMaps=!1,d.updateTextureSamplingMode(2,c);const f=new l.t(null);switch(f._isCube=!0,f._texture=c,g[p]=f,s){case 0:e._lodTextureLow=f;break;case 1:e._lodTextureMid=f;break;case 2:e._lodTextureHigh=f}}}const y=[];for(let r=0;r<t.length;r++)for(let n=0;n<6;n++){const i=t[r][n],o=new Blob([i],{type:s}),a=URL.createObjectURL(o);let l;if(d._features.forceBitmapOverHTMLImageElement)l=d.createImageBitmap(o,{premultiplyAlpha:"none"}).then((t=>x(t,d,p,h,a,n,r,f,g,m,e)));else{const t=new Image;t.src=a,l=new Promise(((s,i)=>{t.onload=()=>{x(t,d,p,h,a,n,r,f,g,m,e).then((()=>s())).catch((e=>{i(e)}))},t.onerror=e=>{i(e)}}))}y.push(l)}if(t.length<o){let r;const n=Math.pow(2,o-1-t.length),s=n*n*4;switch(e.type){case 0:r=new Uint8Array(s);break;case 2:r=new Uint16Array(s);break;case 1:r=new Float32Array(s)}for(let n=t.length;n<o;n++)for(let t=0;t<6;t++)d._uploadArrayBufferViewToTexture(e,r,t,n)}return Promise.all(y).then((()=>{m&&(d._releaseTexture(e),m._swapAndDie(e)),h&&h.dispose(),f&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}(e,function(e,t){const r=(t=h(t)).specular;let n=Math.log2(t.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const s=new Array(n);for(let t=0;t<n;t++){s[t]=new Array(6);for(let n=0;n<6;n++){const i=r.mipmaps[6*t+n];s[t][n]=new Uint8Array(e.buffer,e.byteOffset+r.specularDataPosition+i.position,i.length)}}return s}(t,s),s.imageType)):Promise.resolve()}function x(e,t,r,n,s,i,o,a,l,u,d){return new Promise(((p,c)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{c(e)}),e);n?.onEffectCreatedObservable.addOnce((a=>{a.executeWhenCompiled((()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",r),n.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([n],u,!0,i,o),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(s),p())}))}))}else{if(t._uploadImageToTexture(d,e,i,o),a){const r=l[o];r&&t._uploadImageToTexture(r._texture,e,i,0)}p()}}))}class g{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,n,i){if(Array.isArray(e))return;const a=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<f.length;e++)if(t.getUint8(r++)!==f[e])return d.V.Error("Not a babylon environment map"),null;let n="",s=0;for(;s=t.getUint8(r++);)n+=String.fromCharCode(s);let i=JSON.parse(n);return i=h(i),i.specular&&(i.specular.specularDataPosition=r,i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}(e);if(a){t.width=a.width,t.height=a.width;try{(function(e,t){const r=(t=h(t)).irradiance;if(!r)return;const n=new o.Q;s.Pq.FromArrayToRef(r.x,0,n.x),s.Pq.FromArrayToRef(r.y,0,n.y),s.Pq.FromArrayToRef(r.z,0,n.z),s.Pq.FromArrayToRef(r.xx,0,n.xx),s.Pq.FromArrayToRef(r.yy,0,n.yy),s.Pq.FromArrayToRef(r.zz,0,n.zz),s.Pq.FromArrayToRef(r.yz,0,n.yz),s.Pq.FromArrayToRef(r.zx,0,n.zx),s.Pq.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n})(t,a),m(t,e,a).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}),(e=>{i?.("Can not upload environment levels",e)}))}catch(e){i?.("Can not upload environment file",e)}}else i&&i("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},5999:(e,t,r)=>{r.r(t),r.d(t,{Dispose:()=>v,DumpData:()=>_,DumpDataAsync:()=>g,DumpFramebuffer:()=>x,DumpTools:()=>y});var n=r(5616),s=r(4494),i=r(9848),o=r(4420),a=r(5476);r(6612);const l={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class u{constructor(e,t=l){this._fullscreenViewport=new s.L(0,0,1,1);const r=t.positions??l.positions,i=t.indices??l.indices;this.engine=e,this._vertexBuffers={[n.R.PositionKind]:new n.R(e,r,n.R.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(i),this._onContextRestoredObserver=e.onContextRestoredObservable.add((()=>{this._indexBuffer=e.createIndexBuffer(i);for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}))}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const r=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;r&&this.engine.bindFramebuffer(r),this.applyEffectWrapper(e),this.draw(),r&&this.engine.unBindFramebuffer(r),this.restoreStates()}dispose(){const e=this._vertexBuffers[n.R.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[n.R.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class d{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){let t;this.onApplyObservable=new i.cP;const r=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(r.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)})));const n=e.defines?e.defines.join("\n"):"";this._drawWrapper=new a.E(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],r,e.samplerNames,n,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage,e.extraInitializationsAsync)):(this.effect=new o.M(t,e.attributeNames||["position"],r,e.samplerNames,e.engine,n,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage,e.extraInitializationsAsync),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})))}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}var p=r(998),c=r(4867),f=r(6315);let h,m=null;async function x(e,t,r,n,s="image/png",i,o){const a=await r.readPixels(0,0,e,t);_(e,t,new Uint8Array(a.buffer),n,s,i,!0,void 0,o)}function g(e,t,r,n="image/png",s,i=!1,o=!1,a){return new Promise((l=>{_(e,t,r,(e=>l(e)),n,s,i,o,a)}))}function _(e,t,n,s,i="image/png",o,a=!1,l=!1,x){(async function(){return m||(m=new Promise(((e,t)=>{let n,s=null;const i={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};Promise.resolve().then(r.bind(r,6321)).then((({ThinEngine:o})=>{try{n=new OffscreenCanvas(100,100),s=new o(n,!1,i)}catch(e){n=document.createElement("canvas"),s=new o(n,!1,i)}f.q.Instances.pop(),f.q.OnEnginesDisposedObservable.add((e=>{s&&e!==s&&!s.isDisposed&&0===f.q.Instances.length&&v()})),s.getCaps().parallelShaderCompile=void 0;const a=new u(s);r.e(820).then(r.bind(r,9820)).then((({passPixelShader:r})=>{if(!s)return void t("Engine is not defined");const i=new d({engine:s,name:r.name,fragmentShader:r.shader,samplerNames:["textureSampler"]});h={canvas:n,engine:s,renderer:a,wrapper:i},e(h)}))})).catch(t)}))),await m})().then((r=>{if(r.engine.setSize(e,t,!0),n instanceof Float32Array){const e=new Uint8Array(n.length);let t=n.length;for(;t--;){const r=n[t];e[t]=Math.round(255*(0,c.OQ)(r))}n=e}const u=r.engine.createRawTexture(n,e,t,5,!1,!a,1);r.renderer.setViewport(),r.renderer.applyEffectWrapper(r.wrapper),r.wrapper.effect._bindTexture("textureSampler",u),r.renderer.draw(),l?p.S0.ToBlob(r.canvas,(e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;s&&s(t)},t.readAsArrayBuffer(e)}),i,x):p.S0.EncodeScreenshotCanvasData(r.canvas,s,i,o,x),u.dispose()}))}function v(){h?(h.wrapper.dispose(),h.renderer.dispose(),h.engine.dispose()):m?.then((e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()})),m=null,h=null}const y={DumpData:_,DumpDataAsync:g,DumpFramebuffer:x,Dispose:v};p.S0.DumpData=_,p.S0.DumpDataAsync=g,p.S0.DumpFramebuffer=x},6612:(e,t,r)=>{r.r(t),r.d(t,{postprocessVertexShader:()=>i});const n="postprocessVertexShader",s="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";r(9610).l.ShadersStore[n]=s;const i={name:n,shader:s}}}]);